<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Игра с современным дизайном</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700&display=swap');
  body {
    font-family: 'Exo 2', sans-serif;
    text-align: center;
    background: #f6f0ff;
    margin: 0;
    padding: 20px;
    user-select: none;
    min-height: 100vh;
    position: relative;
  }
  body::before,
  body::after{
    content:'';
    position:fixed;
    width:520px;
    height:520px;
    border-radius:45% 55% 55% 45%;
    background:rgba(142,111,255,.18);
    z-index:-2;
    filter:blur(0);
  }
  body::before{top:-120px;left:-160px;}
  body::after{bottom:-180px;right:-160px;}
  #menu {
    background: #ffffff;
    padding: 28px 32px;
    width: 420px;
    margin: 0 auto 20px auto;
    border-radius: 24px;
    box-shadow: 0 25px 80px rgba(96,33,201,.15);
  }
  label {
    font-weight: 600;
    font-size: 17px;
    color: #1b1130;
    margin: 12px 0 6px 0;
    display: block;
    text-align: left;
  }
  input[type=range] {
    width: 100%;
    height: 6px;
    border-radius: 8px;
    background: linear-gradient(to right, #6630ff, #a353ff);
    outline: none;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  input[type=range]:hover {
    background: linear-gradient(to right, #5720d6, #8c5bff);
  }
  button#startGame {
    margin-top: 18px;
    padding: 14px 32px;
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    background: linear-gradient(120deg, #6630ff, #a353ff);
    border: none;
    border-radius: 999px;
    box-shadow: 0 18px 35px rgba(111,55,230,.35);
    cursor: pointer;
    user-select: none;
    transition: transform 0.25s, box-shadow 0.25s;
  }
  button#startGame:hover {
    transform: translateY(-2px);
    box-shadow: 0 20px 40px rgba(111,55,230,.45);
  }
  #info {
    font-size: 20px;
    font-weight: 600;
    color: #1b1130;
    text-shadow: none;
    margin-bottom: 10px;
  }
  .exit-button {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1000;
    padding: 10px 26px;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    background: linear-gradient(120deg, #6630ff, #a353ff);
    border: none;
    border-radius: 999px;
    box-shadow: 0 18px 35px rgba(111,55,230,.35);
    cursor: pointer;
    user-select: none;
    transition: transform 0.25s, box-shadow 0.25s;
    font-family: 'Exo 2', sans-serif;
  }
  .exit-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 22px 40px rgba(111,55,230,.45);
  }
  .color-label {
    font-weight: 700;
    padding: 5px 14px;
    border-radius: 25px;
    color: white;
    margin: 0 6px;
    display: inline-block;
    min-width: 90px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-size: 16px;
  }
  #gameCanvas {
    background: radial-gradient(ellipse at top, #7e45ff, #5730c3);
    border-radius: 28px;
    box-shadow: 0 25px 80px rgba(96,33,201,.15);
    display: block;
    margin: 0 auto;
    user-select: none;
    padding: 18px;
  }
</style>
</head>
<body>

<button class="exit-button" onclick="exitGame()" title="Выход на главную">Выход</button>

<div id="menu">
  <label for="targetChance">Процент нужного чемодана <span id="targetChanceValue">50%</span></label>
  <input type="range" id="targetChance" min="10" max="90" value="50" step="5">

  <label for="speed">Скорость конвейера <span id="speedValue">4</span></label>
  <input type="range" id="speed" min="1" max="10" value="4" step="1">

  <label for="traffic">Количество чемоданов на конвейер <span id="trafficValue">5</span></label>
  <input type="range" id="traffic" min="2" max="10" value="5" step="1">

  <button id="startGame">Начать игру</button>
</div>

<div id="info"></div>
<canvas id="gameCanvas" style="width: 600px; height: 400px;"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

function adaptCanvasSize() {
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();

  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;

  ctx.setTransform(1, 0, 0, 1, 0, 0);
  ctx.scale(dpr, dpr);
  ctx.font = '18px Arial';
  ctx.textBaseline = 'middle';
  ctx.textAlign = 'center';
}
adaptCanvasSize();
window.addEventListener('resize', adaptCanvasSize);

const suitcaseColors = ['red', 'blue', 'green', 'yellow'];
const stickerColors = ['white', 'black', 'orange', 'purple'];
const conveyorYs = [80, 180, 280];
const suitcaseWidth = 80;
const suitcaseHeight = 50;

let percentTarget = 0.5;
let conveyorSpeed = 4;
let trafficPerConveyor = 5;

let targetSuitcaseColor = '';
let targetStickerColor = '';

const colorTranslations = {
  red: 'красный',
  blue: 'синий',
  green: 'зелёный',
  yellow: 'жёлтый',
  white: 'белый',
  black: 'чёрный',
  orange: 'оранжевый',
  purple: 'фиолетовый'
};

function createColorLabel(colorName) {
  const span = document.createElement('span');
    span.className = 'color-label';
  span.textContent = colorTranslations[colorName] || colorName;
  span.style.backgroundColor = colorName;
  if(colorName === 'white') span.style.color = 'black';
  return span;
}

function randomChoice(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function pickColorSuitcase(usedColors) {
  const candidates = suitcaseColors.filter(c => !usedColors.includes(c));
  if (candidates.length === 0) return randomChoice(suitcaseColors);
  return randomChoice(candidates);
}

function pickColorSticker(usedColors, forbiddenColor) {
  const candidates = stickerColors.filter(c => !usedColors.includes(c) && c !== forbiddenColor);
  if (candidates.length === 0) return randomChoice(stickerColors);
  return randomChoice(candidates);
}

class Suitcase {
  constructor(x, y, conveyorIndex, suitcaseColor, stickerColor, speed) {
    this.x = x;
    this.y = y;
    this.conveyorIndex = conveyorIndex;
    this.suitcaseColor = suitcaseColor;
    this.stickerColor = stickerColor;
    this.speed = speed;
    this.width = suitcaseWidth;
    this.height = suitcaseHeight;
  }
  update() {
    this.x += this.speed;
    if (this.x > canvas.width) this.reset();
  }
  reset() {
    this.x = -this.width - 50;
    let usedSuitcaseColors = suitcases.filter(s => s.conveyorIndex === this.conveyorIndex && s !== this).map(s => s.suitcaseColor);
    let usedStickerColors = suitcases.filter(s => s.conveyorIndex === this.conveyorIndex && s !== this).map(s => s.stickerColor);

    if (Math.random() < percentTarget) {
      this.suitcaseColor = targetSuitcaseColor;
      this.stickerColor = targetStickerColor;
    } else {
      this.suitcaseColor = pickColorSuitcase(usedSuitcaseColors.concat([targetSuitcaseColor]));
      this.stickerColor = pickColorSticker(usedStickerColors, this.suitcaseColor);
    }
    this.speed = speedsPerConveyor[this.conveyorIndex];
  }
  draw() {
    const radius = 10;
    ctx.shadowColor = 'rgba(0,0,0,0.25)';
    ctx.shadowBlur = 6;
    ctx.fillStyle = this.suitcaseColor;
    roundRect(ctx, this.x, this.y, this.width, this.height, radius, true, false);

    ctx.fillStyle = this.stickerColor;
    roundRect(ctx, this.x + this.width/3, this.y + this.height/4, this.width/3, this.height/2, radius / 2, true, false);

    ctx.shadowColor = 'transparent';
    ctx.strokeStyle = '#222';
    ctx.lineWidth = 1.6;
    roundRect(ctx, this.x, this.y, this.width, this.height, radius, false, true);
  }
  isClicked(mx, my) {
    return mx >= this.x && mx <= this.x + this.width &&
      my >= this.y && my <= this.y + this.height;
  }
}

function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
  if (typeof stroke === 'undefined') stroke = true;
  if (typeof radius === 'undefined') radius = 5;
  if (typeof radius === 'number')
    radius = {tl: radius, tr: radius, br: radius, bl: radius};
  else {
    var defaultRadius = {tl: 0, tr: 0, br: 0, bl: 0};
    for (var side in defaultRadius) radius[side] = radius[side] || defaultRadius[side];
  }
  ctx.beginPath();
  ctx.moveTo(x + radius.tl, y);
  ctx.lineTo(x + width - radius.tr, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
  ctx.lineTo(x + width, y + height - radius.br);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
  ctx.lineTo(x + radius.bl, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
  ctx.lineTo(x, y + radius.tl);
  ctx.quadraticCurveTo(x, y, x + radius.tl, y);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}

const suitcases = [];
let speedsPerConveyor = [conveyorSpeed, conveyorSpeed, conveyorSpeed];

function initSuitcases() {
  suitcases.length = 0;
  for (let i = 0; i < conveyorYs.length; i++) {
    let usedSuitcaseColors = [];
    let usedStickerColors = [];

    const minDistance = suitcaseWidth + Math.max(20, conveyorSpeed * 20);

    for (let j = 0; j < trafficPerConveyor; j++) {
      let x = -j * minDistance;
    let suitcaseColor, stickerColor;
      if (Math.random() < percentTarget) {
        suitcaseColor = targetSuitcaseColor;
        stickerColor = targetStickerColor;
      } else {
        suitcaseColor = pickColorSuitcase(usedSuitcaseColors.concat([targetSuitcaseColor]));
        stickerColor = pickColorSticker(usedStickerColors, suitcaseColor);
      }

      usedSuitcaseColors.push(suitcaseColor);
      usedStickerColors.push(stickerColor);

      suitcases.push(new Suitcase(x, conveyorYs[i], i, suitcaseColor, stickerColor, speedsPerConveyor[i]));
    }
  }
}

function updateInfo() {
  const infoDiv = document.getElementById('info');
  infoDiv.textContent = 'Нажмите чемоданы с цветом';
  const suitcaseSpan = createColorLabel(targetSuitcaseColor);
  infoDiv.appendChild(suitcaseSpan);
  infoDiv.appendChild(document.createTextNode(' и наклейкой '));
  const stickerSpan = createColorLabel(targetStickerColor);
  infoDiv.appendChild(stickerSpan);
}

function chooseTarget() {
  do {
    targetSuitcaseColor = randomChoice(suitcaseColors);
    targetStickerColor = randomChoice(stickerColors);
  } while (targetStickerColor === targetSuitcaseColor);
  updateInfo();
  initSuitcases();
}

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  suitcases.forEach(suitcase => {
    if (suitcase.isClicked(mx, my)) {
      if (suitcase.suitcaseColor === targetSuitcaseColor && suitcase.stickerColor === targetStickerColor) {
        alert('Правильно!');
        chooseTarget();
      } else {
        alert('Неправильно, попробуйте снова.');
      }
    }
  });
});

let conveyorOffset = 0;

function drawConveyor(y, speed) {
  const beltHeight = 60;
  const beltWidth = canvas.width;
  const stripeWidth = 40;
  const stripeHeight = 20;

  let grad = ctx.createLinearGradient(0, y - 5, 0, y + beltHeight);
  grad.addColorStop(0, '#394a79');
  grad.addColorStop(1, '#222f4f');
  ctx.fillStyle = grad;
  ctx.shadowColor = 'rgba(0,0,0,0.6)';
  ctx.shadowBlur = 8;
  ctx.shadowOffsetY = 4;
  ctx.fillRect(0, y - 5, beltWidth, beltHeight);
  ctx.shadowColor = 'transparent';

  ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
  let offset = (conveyorOffset * speed / 4) % (stripeWidth * 2);

  for (let x = -stripeWidth + offset; x < beltWidth; x += stripeWidth * 2) {
    ctx.fillRect(x, y + 10, stripeWidth, stripeHeight);
  }
}

function averageSpeed() {
  let sum = 0;
  suitcases.forEach(s => sum += s.speed);
  return sum / suitcases.length;
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  let avgSpeed = averageSpeed();
  conveyorOffset += avgSpeed;

  conveyorYs.forEach((y, i) => drawConveyor(y, speedsPerConveyor[i]));

  suitcases.forEach(suitcase => {
    suitcase.update();
    suitcase.draw();
  });

  requestAnimationFrame(gameLoop);
}

document.getElementById('targetChance').addEventListener('input', (e) => {
  percentTarget = e.target.value / 100;
  document.getElementById('targetChanceValue').textContent = e.target.value + '%';
});

document.getElementById('speed').addEventListener('input', (e) => {
  conveyorSpeed = Number(e.target.value);
  speedsPerConveyor = [conveyorSpeed, conveyorSpeed, conveyorSpeed];
  document.getElementById('speedValue').textContent = conveyorSpeed;
});

document.getElementById('traffic').addEventListener('input', (e) => {
  trafficPerConveyor = Number(e.target.value);
  document.getElementById('trafficValue').textContent = trafficPerConveyor;
});

document.getElementById('startGame').addEventListener('click', () => {
  chooseTarget();
  initSuitcases();
  conveyorOffset = 0;
  gameLoop();
  document.getElementById('menu').style.display = 'none';
  canvas.style.display = 'block';
  document.getElementById('info').style.display = 'block';
});

canvas.style.display = 'none';
document.getElementById('info').style.display = 'none';

function exitGame(){
  window.location.href = '../test.html';
}

</script>

</body>
</html>